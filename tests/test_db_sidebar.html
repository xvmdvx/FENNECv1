<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FENNEC DB Sidebar Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .mock-db-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .order-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .order-panel {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FENNEC DB Sidebar Test</h1>
        
        <div class="test-section">
            <h3>Test 1: DiagnoseFloater Initialization</h3>
            <div class="description">Test if DiagnoseFloater initializes without errors</div>
            <button class="test-button" onclick="testDiagnoseFloater()">
                Test DiagnoseFloater
            </button>
            <div id="diagnose-result" class="status info">Click to test DiagnoseFloater initialization</div>
        </div>

        <div class="test-section">
            <h3>Test 2: Sidebar Initialization</h3>
            <div class="description">Test if sidebar can be initialized</div>
            <button class="test-button" onclick="testSidebarInit()">
                Test Sidebar Init
            </button>
            <div id="sidebar-result" class="status info">Click to test sidebar initialization</div>
        </div>

        <div class="test-section">
            <h3>Test 3: Mock DB Environment</h3>
            <div class="description">Simulate DB environment and test sidebar</div>
            <button class="test-button" onclick="testMockDB()">
                Test Mock DB Environment
            </button>
            <div id="mockdb-result" class="status info">Click to test mock DB environment</div>
        </div>

        <div class="test-section">
            <h3>Test 4: Error Handling</h3>
            <div class="description">Test error handling when components fail to load</div>
            <button class="test-button" onclick="testErrorHandling()">
                Test Error Handling
            </button>
            <div id="error-result" class="status info">Click to test error handling</div>
        </div>

        <div class="mock-db-content">
            <h3>Mock DB Order Detail Page</h3>
            <div class="order-info">
                <div class="order-panel">
                    <h4>Order Information</h4>
                    <p><strong>Order ID:</strong> 225082006613</p>
                    <p><strong>Status:</strong> SILVER - SCORP</p>
                    <p><strong>Company:</strong> ADAM AMERICAN DIVORCE ASSOCIATION FOR MEN METRO DETROIT LICENSING INC.</p>
                </div>
                <div class="order-panel">
                    <h4>Company Information</h4>
                    <p><strong>State:</strong> Michigan</p>
                    <p><strong>Type:</strong> Justice, Public Order, and Safety Activities</p>
                    <p><strong>Address:</strong> Bloomfield Hills, MI 48302</p>
                </div>
                <div class="order-panel">
                    <h4>Issue History</h4>
                    <p><strong>Status:</strong> Pending</p>
                    <p><strong>Last Update:</strong> Aug 25, 2025 11:27 am</p>
                    <p><strong>Assigned:</strong> irvin I.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock Chrome API for testing
        if (typeof chrome === 'undefined') {
            window.chrome = {
                storage: {
                    local: {
                        get: function(keys, callback) {
                            const mockData = {
                                extensionEnabled: true,
                                fennecReviewMode: false,
                                fennecDevMode: false,
                                environments: {
                                    gmail: true,
                                    db: true,
                                    usps: true,
                                    adyen: true,
                                    kount: true,
                                    txsos: true
                                },
                                autoUpload: false,
                                sidebarDb: [],
                                sidebarOrderId: null,
                                fennecActiveSession: null
                            };
                            callback(mockData);
                        },
                        set: function(data, callback) {
                            console.log('Mock storage set:', data);
                            if (callback) callback();
                        }
                    },
                    sync: {
                        get: function(keys, callback) {
                            const mockData = { 
                                fennecReviewMode: false,
                                fennecDevMode: false,
                                sidebarFontSize: 13,
                                sidebarFont: "'Inter', sans-serif",
                                sidebarBgColor: '#212121',
                                sidebarBoxColor: '#2e2e2e'
                            };
                            callback(mockData);
                        },
                        set: function(data, callback) {
                            console.log('Mock sync storage set:', data);
                            if (callback) callback();
                        }
                    },
                    onChanged: {
                        addListener: function(callback) {
                            console.log('Mock storage change listener added');
                        }
                    }
                },
                runtime: {
                    sendMessage: function(message, callback) {
                        console.log('Mock runtime message:', message);
                        if (callback) callback({ success: true });
                    },
                    getURL: function(path) {
                        return 'chrome-extension://mock/' + path;
                    }
                }
            };
        }

        // Mock sessionStorage
        if (typeof sessionStorage === 'undefined') {
            window.sessionStorage = {
                getItem: function(key) { return null; },
                setItem: function(key, value) { console.log('Mock sessionStorage set:', key, value); },
                removeItem: function(key) { console.log('Mock sessionStorage remove:', key); }
            };
        }

        // Mock localStorage
        if (typeof localStorage === 'undefined') {
            window.localStorage = {
                getItem: function(key) { return null; },
                setItem: function(key, value) { console.log('Mock localStorage set:', key, value); },
                removeItem: function(key) { console.log('Mock localStorage remove:', key); }
            };
        }

        // Mock Floater class
        if (typeof window.Floater === 'undefined') {
            window.Floater = class Floater {
                constructor(id, headerId = null, headerText = '') {
                    this.id = id;
                    this.headerId = headerId;
                    this.headerText = headerText;
                    this.element = null;
                    this.header = null;
                }

                exists() {
                    return document.getElementById(this.id);
                }

                build() {
                    this.element = document.createElement('div');
                    this.element.id = this.id;
                    if (this.headerId) {
                        this.header = document.createElement('div');
                        this.header.id = this.headerId;
                        this.header.textContent = this.headerText;
                    }
                }

                attach(parent = document.body) {
                    if (this.header && !document.getElementById(this.headerId)) {
                        parent.appendChild(this.header);
                    }
                    if (this.element && !this.exists()) {
                        parent.appendChild(this.element);
                    }
                }

                remove() {
                    if (this.element) this.element.remove();
                    if (this.header) this.header.remove();
                }
            };
        }

        // Mock DiagnoseFloater class
        if (typeof window.DiagnoseFloater === 'undefined') {
            window.DiagnoseFloater = class DiagnoseFloater extends window.Floater {
                constructor() {
                    super('fennec-diagnose-overlay', 'fennec-diagnose-header', 'Diagnose Issues');
                    this.issues = [];
                }

                init() {
                    console.log('[FENNEC] Diagnose floater initialized');
                }
                
                build() {
                    super.build();
                    if (this.element) {
                        this.element.className = 'fennec-diagnose-overlay';
                        this.element.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: white;
                            border: 2px solid #007bff;
                            border-radius: 8px;
                            padding: 20px;
                            z-index: 10000;
                            max-width: 80vw;
                            max-height: 80vh;
                            overflow-y: auto;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        `;
                        
                        this.element.innerHTML = `
                            <div style="margin-bottom: 15px;">
                                <h3 style="margin: 0 0 10px 0; color: #333;">Order Diagnostic</h3>
                                <div id="diagnose-content">
                                    <p>Loading diagnostic information...</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <button id="diagnose-close" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                            </div>
                        `;
                        
                        const closeBtn = this.element.querySelector('#diagnose-close');
                        if (closeBtn) {
                            closeBtn.addEventListener('click', () => this.remove());
                        }
                    }
                }
                
                diagnose(orderId) {
                    console.log('[FENNEC] Running diagnostic for order:', orderId);
                    const content = this.element?.querySelector('#diagnose-content');
                    if (content) {
                        content.innerHTML = `
                            <div style="margin-bottom: 10px;">
                                <strong>Order ID:</strong> ${orderId}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Status:</strong> Analyzing...
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Issues Found:</strong> 0
                            </div>
                        `;
                    }
                }
            };
        }

        // Mock Sidebar class
        if (typeof window.Sidebar === 'undefined') {
            window.Sidebar = class Sidebar {
                constructor(id = 'copilot-sidebar') {
                    this.id = id;
                    this.element = null;
                }

                exists() {
                    return document.getElementById(this.id);
                }

                build(html) {
                    const container = document.createElement('div');
                    container.id = this.id;
                    container.innerHTML = html;
                    this.element = container;
                }

                attach(parent = document.body) {
                    if (this.element && !this.exists()) {
                        parent.appendChild(this.element);
                    }
                }

                remove() {
                    const el = this.exists();
                    if (el) el.remove();
                }
            };
        }

        function testDiagnoseFloater() {
            const resultDiv = document.getElementById('diagnose-result');
            try {
                const floater = new window.DiagnoseFloater();
                floater.build();
                floater.attach();
                
                resultDiv.className = 'status success';
                resultDiv.innerHTML = `
                    <strong>✅ DiagnoseFloater Test Successful!</strong><br>
                    - Class initialized without errors<br>
                    - Element created and attached to DOM<br>
                    - Element ID: ${floater.id}<br>
                    - Element exists: ${floater.exists()}
                `;
                
                // Remove after 3 seconds
                setTimeout(() => floater.remove(), 3000);
                
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.innerHTML = `
                    <strong>❌ DiagnoseFloater Test Failed!</strong><br>
                    Error: ${error.message}<br>
                    Stack: ${error.stack}
                `;
            }
        }

        function testSidebarInit() {
            const resultDiv = document.getElementById('sidebar-result');
            try {
                const sidebar = new window.Sidebar();
                const testHtml = `
                    <div style="background: #333; color: white; padding: 20px; width: 300px;">
                        <h3>Test Sidebar</h3>
                        <p>This is a test sidebar content.</p>
                        <button onclick="this.parentElement.remove()">Close</button>
                    </div>
                `;
                
                sidebar.build(testHtml);
                sidebar.attach();
                
                resultDiv.className = 'status success';
                resultDiv.innerHTML = `
                    <strong>✅ Sidebar Test Successful!</strong><br>
                    - Sidebar class initialized without errors<br>
                    - Element created and attached to DOM<br>
                    - Element ID: ${sidebar.id}<br>
                    - Element exists: ${sidebar.exists()}
                `;
                
                // Remove after 3 seconds
                setTimeout(() => sidebar.remove(), 3000);
                
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.innerHTML = `
                    <strong>❌ Sidebar Test Failed!</strong><br>
                    Error: ${error.message}<br>
                    Stack: ${error.stack}
                `;
            }
        }

        function testMockDB() {
            const resultDiv = document.getElementById('mockdb-result');
            try {
                // Simulate DB environment
                const mockUrl = 'https://db.incfile.com/incfile/order/detail/225082006613';
                const mockPathname = '/incfile/order/detail/225082006613';
                
                // Mock location object
                const originalLocation = window.location;
                Object.defineProperty(window, 'location', {
                    value: {
                        href: mockUrl,
                        pathname: mockPathname,
                        origin: 'https://db.incfile.com',
                        search: ''
                    },
                    writable: true
                });
                
                // Test DiagnoseFloater initialization
                let diagnoseFloater = null;
                try {
                    diagnoseFloater = new window.DiagnoseFloater();
                    console.log('[FENNEC] DiagnoseFloater initialized successfully');
                } catch (floaterError) {
                    console.warn('[FENNEC] Failed to initialize DiagnoseFloater:', floaterError);
                    diagnoseFloater = null;
                }
                
                // Test sidebar initialization
                const sidebar = new window.Sidebar();
                const sidebarHtml = `
                    <div style="background: #333; color: white; padding: 20px; width: 300px; position: fixed; right: 0; top: 0; height: 100vh; overflow-y: auto;">
                        <h3>FENNEC Sidebar</h3>
                        <div style="margin: 20px 0;">
                            <strong>Order ID:</strong> 225082006613<br>
                            <strong>Status:</strong> SILVER - SCORP<br>
                            <strong>Company:</strong> ADAM AMERICAN DIVORCE ASSOCIATION FOR MEN METRO DETROIT LICENSING INC.
                        </div>
                        <div style="margin: 20px 0;">
                            <button onclick="this.parentElement.parentElement.remove()">Close Sidebar</button>
                        </div>
                    </div>
                `;
                
                sidebar.build(sidebarHtml);
                sidebar.attach();
                
                resultDiv.className = 'status success';
                resultDiv.innerHTML = `
                    <strong>✅ Mock DB Environment Test Successful!</strong><br>
                    - DiagnoseFloater: ${diagnoseFloater ? '✅ Initialized' : '⚠️ Failed to initialize'}<br>
                    - Sidebar: ✅ Created and attached<br>
                    - Mock URL: ${mockUrl}<br>
                    - Mock Pathname: ${mockPathname}
                `;
                
                // Restore original location
                Object.defineProperty(window, 'location', {
                    value: originalLocation,
                    writable: true
                });
                
                // Remove sidebar after 5 seconds
                setTimeout(() => sidebar.remove(), 5000);
                
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.innerHTML = `
                    <strong>❌ Mock DB Environment Test Failed!</strong><br>
                    Error: ${error.message}<br>
                    Stack: ${error.stack}
                `;
            }
        }

        function testErrorHandling() {
            const resultDiv = document.getElementById('error-result');
            try {
                // Test error handling when DiagnoseFloater fails
                const originalDiagnoseFloater = window.DiagnoseFloater;
                
                // Temporarily break DiagnoseFloater
                window.DiagnoseFloater = class BrokenDiagnoseFloater {
                    constructor() {
                        throw new Error('Simulated DiagnoseFloater error');
                    }
                };
                
                // Try to initialize broken DiagnoseFloater
                let diagnoseFloater = null;
                try {
                    diagnoseFloater = new window.DiagnoseFloater();
                } catch (floaterError) {
                    console.warn('[FENNEC] Expected error caught:', floaterError);
                    diagnoseFloater = null;
                }
                
                // Test that sidebar still works even when DiagnoseFloater fails
                const sidebar = new window.Sidebar();
                const sidebarHtml = `
                    <div style="background: #333; color: white; padding: 20px; width: 300px; position: fixed; right: 0; top: 0; height: 100vh; overflow-y: auto;">
                        <h3>FENNEC Sidebar (Error Handling Test)</h3>
                        <p>This sidebar loaded even though DiagnoseFloater failed.</p>
                        <div style="margin: 20px 0;">
                            <strong>DiagnoseFloater Status:</strong> ${diagnoseFloater ? '✅ Working' : '❌ Failed (as expected)'}
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()">Close Sidebar</button>
                    </div>
                `;
                
                sidebar.build(sidebarHtml);
                sidebar.attach();
                
                resultDiv.className = 'status success';
                resultDiv.innerHTML = `
                    <strong>✅ Error Handling Test Successful!</strong><br>
                    - DiagnoseFloater error was caught and handled gracefully<br>
                    - Sidebar still loaded successfully despite DiagnoseFloater failure<br>
                    - No unhandled errors in console
                `;
                
                // Restore original DiagnoseFloater
                window.DiagnoseFloater = originalDiagnoseFloater;
                
                // Remove sidebar after 5 seconds
                setTimeout(() => sidebar.remove(), 5000);
                
            } catch (error) {
                resultDiv.className = 'status error';
                resultDiv.innerHTML = `
                    <strong>❌ Error Handling Test Failed!</strong><br>
                    Error: ${error.message}<br>
                    Stack: ${error.stack}
                `;
            }
        }

        console.log('[TEST] FENNEC DB Sidebar Test Page Loaded');
        console.log('[TEST] Mock Chrome API initialized');
        console.log('[TEST] Mock Floater class available:', typeof window.Floater);
        console.log('[TEST] Mock DiagnoseFloater class available:', typeof window.DiagnoseFloater);
        console.log('[TEST] Mock Sidebar class available:', typeof window.Sidebar);
    </script>
</body>
</html>
